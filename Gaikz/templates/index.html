<!DOCTYPE html>
    <head>
        <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='css/bootstrap.min.css') }}">

        <script src="{{ url_for('static',filename='js/jquery.min.js') }}"></script>
        <script src="{{ url_for('static',filename='js/bootstrap.min.js') }}"></script>
        <script src="{{ url_for('static',filename='d3/d3.v4.min.js') }}"></script>

        <!-- <link href="{{ url_for('static',filename='vendor/bootstrap/css/bootstrap.min.css') }}" rel="stylesheet"> -->
        <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='css/style.css') }}">

    </head>

    <title>
        Deaths Dashboard
    </title>

    <body>
        <div style="padding-left:5px; padding-right: 5px;"class="container-fluid">
            <nav style="padding-top:0%; padding-bottom: 0%;" class="navbar navbar-expand-lg navbar-light bg-light">
                <span class="navbar-brand">The Annual Global Deaths Dashboard</span>

                <form class="form-inline">
                    <button class="btn btn-sm btn-outline-secondary" type="button" onclick="setToDefault();">Reset Dashboard</button>
                </form>
                
                <div class="collapse navbar-collapse" id="navbarSupportedContent">

                    <ul class="navbar-nav ml-auto mt-2 mt-lg-0">
                      <!-- Navbar dd 1 -->
                      <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown_year" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                          Year
                        </a>
                        <div id="years-dropdown-list" class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                            <!-- <a class="years-dropdown-item dropdown-item"> 2007 </a>
                            <a class="years-dropdown-item dropdown-item"> 2008 </a> -->
                        </div>
                      </li>
                      <!-- Navbar dd 2 -->
                      <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                          Countries
                        </a>
                        <ul id="countries-dropdown-list" class="dropdown-menu checkbox-menu dropdown-menu-right allow-focus" aria-labelledby="dropdownMenu1">
  
                            <!-- <li >
                              <label>
                                <input type="checkbox"> Cheese
                              </label>
                            </li> -->
                            
                        </ul>
                        <!-- <div id="countries-dropdown-list" class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                          
                        </div> -->
                      </li>
                      <!-- Navbar dd 3 -->
                      <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                          Causes of Death
                        </a>
                        <ul id="causes-dropdown-list" class="dropdown-menu checkbox-menu dropdown-menu-right allow-focus" aria-labelledby="dropdownMenu2">
                        
                        </ul>
                      </li>
                    </ul>
                </div>
            </nav>

            <div class="row">
                <div class="col-md-6" id = "r1c1">
                <!-- <div class="col-lg" id = "r1c1"></div> -->
                    <div id="world_map_div" class="border border-dark">
                        <svg id="world_map" width="" height=""></svg>
                    </div>
                    <div id="parallel_coordinates" class="col-md-6 border-dark">
                    </div>                    
                </div>
                <div class="col-md-6" id = "r1c2">
                    <!-- 2 -->
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 border border-dark" id = "scatterplot">
                </div>
                    
                <div class="col-md-6 border border-dark" id = "barplot">
                </div>

            </div>
        
        </div>
        
        <!-- Bootstrap core JavaScript -->
        <!-- <script src="{{ url_for('static',filename='vendor/jquery/jquery.min.js') }}"></script> -->
        <!-- <script src="{{ url_for('static',filename='vendor/bootstrap/js/bootstrap.bundle.min.js') }}"></script> -->
        <script src="{{ url_for('static',filename='js/d3-scale-chromatic.v1.min.js') }}"></script>
        <script src="{{ url_for('static',filename='js/d3-geo-projection.v2.min.js') }}"></script>

        <!-- Menu Toggle Script -->
        <!-- <script src="{{ url_for('static',filename='js/custom-js/menu.js') }}"></script> -->

        <!-- Map Script -->
        <script src="{{ url_for('static',filename='js/custom-js/map.js') }}"></script>

        <!-- Parallel Coordinates Script -->
        <script src="{{ url_for('static',filename='js/custom-js/parallel.js') }}"></script>

        <!-- Scatterplot Script -->
        <script src="{{ url_for('static',filename='js/custom-js/scatterplot.js') }}"></script>

        <!-- Barplot Script -->
        <script src="{{ url_for('static',filename='js/custom-js/barplot.js') }}"></script>

        <script>
            var all_data = {{ returned_data.all_data | safe }}
            var unique_years = new Set([]);
            var unique_countries = new Set([]);
            var all_causes = Object.keys(all_data[0]).slice(4, 38);
            all_data.forEach(element => {
                unique_countries.add(element["Country"])
            });
            all_data.forEach(element => {
                unique_years.add(element["Year"])
            });
            
            unique_years = Array.from(unique_years).sort();

            // Populate years
            d3.select("#years-dropdown-list")
                .selectAll("a")
                .data(Array.from(unique_years))
                .enter()
                .append("a")
                .text(function (d) {
                    return d;
                })
                .attr("value", function (d) {
                    return d;
                })
                .attr("onclick", function (d) {
                    return "get_year_data(" + d + ")";
                })
                .attr("class", "dropdown-item")
                .attr("id", "years-dropdown-item");

            // populate countries
            var divs_countries = d3.select("#countries-dropdown-list")
                        .selectAll("li")
                        .data(Array.from(unique_countries))
                        .enter()
                        .append("li")
                        .append("label")
                            .text(function (d) { return d; })
                        .append("input")
                            .attr("type", "checkbox");
            
            var divs_countries = d3.select("#causes-dropdown-list")
                    .selectAll("li")
                    .data(Array.from(all_causes))
                    .enter()
                    .append("li")
                    .append("label")
                        .text(function (d) { return d; })
                    .append("input")
                        .attr("type", "checkbox");
            
        </script>

        <script>
            $(document).on('click', '.allow-focus', function (e) {
                e.stopPropagation();
            });

            // default values
            var selected_countries;
            var selected_causes;
            var year;
            var data;
            setToDefault();

            // for reset button
            function setToDefault() {
                // default values
                selected_countries = new Set(["Albania", "Afghanistan", "Argentina"]);
                selected_causes = new Set(["Cardiovascular diseases (%)", "Cancers (%)", "Respiratory diseases (%)", "Diabetes (%)"]);
                year = "2016";

                // call the graphs
                get_year_data(year);

                // set default active countries and causes
                d3.select("#countries-dropdown-list").selectAll("li")
                    .classed("active", function (d) {
                        if (selected_countries.has(d3.select(this).select("label").text())) {
                            d3.select(this).select("input").property('checked', true);
                            return true;
                        }
                        else {
                            d3.select(this).select("input").property('checked', false);
                            return false;
                        }
                    })
                
                d3.select("#causes-dropdown-list").selectAll("li")
                    .classed("active", function (d) {

                        if (selected_causes.has(d3.select(this).select("label").text())) {
                            d3.select(this).select("input").property('checked', true);
                            return true;
                        }
                        else {
                            d3.select(this).select("input").property('checked', false);
                            return false;
                        }
                    })
            }

            function on_update() {
                // console.log(data["bar_plot"])
                plotScatterPlot(data["pca_plot"]);
                plotBarPlot(data["bar_plot"]);
                parallel_plot();
                
                // toggle year on select
                // var a = $('a').filter(function(){
                //     return $(this).text() == year;
                // });
                // console.log(a.text());
                
                // toggle year on select
                d3.select("#years-dropdown-list").selectAll("a")
                    .classed("active", function (d) {
                        if (d == year)
                            return true;
                        else
                            return false;
                    });
            }

            $(".checkbox-menu").on("change", "input[type='checkbox']", function() {
                
                // change checkbox color
                $(this).closest("li").toggleClass("active", this.checked);

                selected_countries = new Set();
                $.each($("#countries-dropdown-list li label"), function(){
                    if ($(this).children()[0].checked)
                        selected_countries.add($(this).text());
                });

                selected_causes = new Set();
                $.each($("#causes-dropdown-list li label"), function(){
                    if ($(this).children()[0].checked)
                        selected_causes.add($(this).text());
                });

                // console.log(selected_countries, selected_causes);
                get_year_data(year);

            });

            function get_year_data(f_year) {
                // selected_years.add(parseInt(this.text));
                year = f_year;

                var url_string = "/dropdown?years=";
                url_string += f_year

                selected_causes.forEach(element => url_string += "&causes=" + element);
                selected_countries.forEach(element => url_string += "&countries=" + element);

                $.ajax({
                    url: url_string,
                    success: function(response) {
                        data = JSON.parse(response);
                        on_update();
                    }
                })
            }
        </script>

    </body>

</html>